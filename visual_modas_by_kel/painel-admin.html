<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="design/icone_visualmodasbykel.png">
    <title>Painel Administrativo | Visual Modas By Kel</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="estilos.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a style="text-decoration:none;">
                <span class="logo" style="position:static;transform:none;left:auto;z-index:auto;flex:0 0 auto;">
                    VISUAL MODAS BY KEL
                </span>
            </a>

            <a>
                <img src="design/logo_visualmodasbykel.png" alt="Logo Decorativa" style="height:38px;">
            </a>

            <div class="header-icons" style="gap: 24px;">
                <a href="/usuario" style="font-size:12px;display:flex;align-items:center;gap:4px;">
                    <img src="design/icone_usuario.png" alt="Minha Conta">
                    <span>Minha conta e<br><b style="color:#fff;">Meus pedidos</b></span>
                </a>

                <a href="#" style="font-size:12px;display:flex;align-items:center;gap:4px;" onclick="logout()">
                    <img src="design/icone_sair.png" alt="Sair">
                </a>
            </div>
        </div>
    </header>

    <div class="painel-admin-container">
        <aside class="painel-admin-sidebar">
            <nav>
                <ul class="painel-sidebar-menu">
                    <li><a href="#" class="menu-item active" data-section="produtos">
                            <span class="painel-icon">üëó</span>
                            Produtos
                        </a></li>
                    <li><a href="#" class="menu-item" data-section="pedidos">
                            <span class="painel-icon">üõí</span>
                            Pedidos
                        </a></li>
                </ul>
            </nav>
        </aside>

        <main class="painel-admin-main">
            <div id="produtos-section" class="painel-admin-section">
                <div class="painel-admin-header">
                    <h1 class="painel-admin-title">Produtos</h1>
                    <p class="painel-admin-subtitle">Gerenciamento de produtos</p>
                </div>
                <div class="painel-content-section">
                    <div class="painel-section-header">
                        <h2 class="painel-section-title">Lista de Produtos</h2>
                        <button class="painel-btn-primary" onclick="openModal('produto-modal')">Adicionar
                            Produto</button>
                    </div>
                    <div class="painel-search-bar">
                        <input type="text" class="painel-search-input" placeholder="Buscar produtos...">
                    </div>
                    <table class="painel-data-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Se√ß√£o</th>
                                <th>Nome</th>
                                <th>Pre√ßo</th>
                                <th>Tamanho</th>
                                <th>G√™nero</th>
                                <th>Categoria</th>
                                <th>Descri√ß√£o</th>
                                <th>Foto</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-list">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="pedidos-section" class="painel-admin-section painel-hidden">
                <div class="painel-admin-header">
                    <h1 class="painel-admin-title">Pedidos</h1>
                    <p class="painel-admin-subtitle">Gerenciamento de pedidos</p>
                </div>

                <div class="painel-content-section">
                    <div class="painel-section-header">
                        <h2 class="painel-section-title">Lista de Pedidos</h2>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 18px; font-weight: 600; color: #370400;">
                                Total em vendas: <span id="total-vendas">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    <div class="painel-search-bar">
                        <input type="text" class="painel-search-input" placeholder="Buscar pedidos...">
                    </div>
                    <table class="painel-data-table">
                        <thead>
                            <tr>
                                <th>Pedido</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal de Cadastro de Produto -->
    <div id="produto-modal" class="painel-modal">
        <div class="painel-modal-content">
            <div class="painel-modal-header">
                <h2 class="painel-modal-title">Adicionar Produto</h2>
                <button class="painel-close-btn" onclick="closeModal('produto-modal')">&times;</button>
            </div>
            <div class="painel-modal-body">
                <form id="produto-form">
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Nome</label>
                        <input type="text" id="nome-produto" class="painel-admin-form-input" required>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Descri√ß√£o</label>
                        <textarea id="descricao-produto" class="painel-admin-form-textarea" rows="4"
                            placeholder="Descri√ß√£o detalhada do produto..." required></textarea>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Pre√ßo (R$)</label>
                        <input type="number" id="preco-produto" step="0.01" class="painel-admin-form-input" required>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Tamanho</label>
                        <select id="tamanho-produto" class="painel-admin-form-select" required>
                            <option value="">Selecione o tamanho</option>
                            <option value="PP">PP</option>
                            <option value="P">P</option>
                            <option value="M">M</option>
                            <option value="G">G</option>
                            <option value="GG">GG</option>
                            <option value="XG">XG</option>
                            <option value="XGG">XGG</option>
                        </select>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Categoria</label>
                        <select id="categoria-produto" class="painel-admin-form-select" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="Vestidos">Vestidos</option>
                            <option value="Blusas e Camisas">Blusas e Camisas</option>
                            <option value="Cal√ßas">Cal√ßas</option>
                            <option value="Saias">Saias</option>
                            <option value="Shorts e Bermudas">Shorts e Bermudas</option>
                            <option value="Jaquetas e Casacos">Jaquetas e Casacos</option>
                            <option value="Macac√µes">Macac√µes</option>
                            <option value="Blazers">Blazers</option>
                            <option value="Body">Body</option>
                            <option value="Regatas">Regatas</option>
                        </select>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Se√ß√£o</label>
                        <select id="secao-produto" class="painel-admin-form-select" required>
                            <option value="Geral">Geral</option>
                            <option value="Novidades">Novidades</option>
                            <option value="Destaques">Destaques</option>
                        </select>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">G√™nero</label>
                        <select id="genero-produto" class="painel-admin-form-select" required>
                            <option value="Unissex">Unissex</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                    <div class="painel-admin-form-group">
                        <label class="painel-admin-form-label">Foto</label>
                        <div class="painel-file-upload">
                            <input type="file" id="foto-produto" accept="image/jpeg,image/jpg,image/png,image/webp"
                                style="display: none;" required>
                            <div onclick="document.getElementById('foto-produto').click()"
                                style="cursor: pointer; padding: 20px; text-align: center; border: 2px dashed #ddd; border-radius: 4px;">
                                <p>Clique para selecionar a foto</p>
                                <small>Formatos aceitos: JPG, PNG, WEBP (m√°x. 5MB)</small>
                            </div>
                        </div>
                        <div id="preview-imagem"></div>
                    </div>
                </form>
            </div>
            <div class="painel-modal-footer">
                <button type="button" class="painel-btn-secondary"
                    onclick="closeModal('produto-modal')">Cancelar</button>
                <button type="submit" class="painel-btn-primary" form="produto-form">Salvar Produto</button>
            </div>
        </div>
    </div>

    <script src="js/pedidos.js"></script>
    <script src="js/cadastro-produto.js"></script>
    <script src="js/admin-pedidos.js"></script>

    <!-- Scripts do painel admin -->
    <script>
        // Navega√ß√£o do menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();

                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.painel-admin-section').forEach(section => {
                    section.classList.add('painel-hidden');
                });

                const sectionName = this.dataset.section;
                document.getElementById(sectionName + '-section').classList.remove('painel-hidden');

                // Se for a se√ß√£o de produtos, carregar a lista
                if (sectionName === 'produtos') {
                    carregarProdutos();
                }
            });
        });

        // Fun√ß√µes do modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Limpar o formul√°rio ao fechar
            if (modalId === 'produto-modal') {
                document.getElementById('produto-form').reset();
                if (typeof imagemBase64 !== 'undefined') {
                    imagemBase64 = "";
                }
                document.getElementById('preview-imagem').innerHTML = "";
            }
        }

        // Fechar modal ao clicar fora
        window.addEventListener('click', function (event) {
            if (event.target.classList.contains('painel-modal')) {
                event.target.style.display = 'none';
            }
        });

        // Fun√ß√£o para carregar produtos
        function carregarProdutos() {
            $.ajax({
                url: '/api/produtos',
                method: 'GET',
                success: function (produtos) {
                    const tbody = document.getElementById('produtos-list');
                    tbody.innerHTML = '';

                    if (!produtos || produtos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Nenhum produto encontrado</td></tr>';
                        return;
                    }

                    produtos.forEach(produto => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${produto.id || ''}</td>
                            <td>${produto.secao || '-'}</td>
                            <td>${produto.nome || ''}</td>
                            <td>R$ ${(produto.preco || 0).toFixed(2)}</td>
                            <td>${produto.tamanho || ''}</td>
                            <td>${produto.genero || '-'}</td>
                            <td>${produto.categoria || ''}</td>
                            <td>${produto.descricao ? produto.descricao.substring(0, 50) + '...' : ''}</td>
                            <td>${produto.foto_url ? '<img src="' + (produto.foto_url.startsWith('http') ? produto.foto_url : (produto.foto_url.startsWith('/') ? 'http://localhost:5000' + produto.foto_url : 'http://localhost:5000/' + produto.foto_url)) + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">' : '-'}</td>
                            <td>
                                <button class="painel-btn-danger" style="padding: 10px 20px; font-size: 14px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;" onclick="deletarProduto(${produto.id})">Excluir</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Erro ao carregar produtos:", error);
                    document.getElementById('produtos-list').innerHTML =
                        '<tr><td colspan="10" style="text-align: center; color: red;">Erro ao carregar produtos</td></tr>';
                }
            });
        }

        // Fun√ß√£o logout
        function logout() {
            Swal.fire({
                title: 'Sair do painel?',
                text: 'Tem certeza que deseja sair do painel administrativo?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#370400',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, sair',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch('/logout', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'At√© logo!',
                                text: 'Logout realizado com sucesso',
                                confirmButtonColor: '#370400',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = '/login';
                            });
                        } else {
                            throw new Error('Erro ao fazer logout');
                        }
                    } catch (error) {
                        console.error('Erro ao fazer logout:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'N√£o foi poss√≠vel fazer logout. Tente novamente.',
                            confirmButtonColor: '#370400'
                        });
                    }
                }
            });
        }

        // Busca nas tabelas
        document.querySelectorAll('.painel-search-input').forEach(input => {
            input.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const table = this.closest('.painel-content-section').querySelector('.painel-data-table tbody');
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        });

        // Carregar produtos ao iniciar o painel
        document.addEventListener('DOMContentLoaded', function () {
            carregarProdutos();
        });

        // Fun√ß√£o para mobile sidebar
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.painel-admin-sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Adicionar bot√£o hamburger em mobile
        if (window.innerWidth <= 768) {
            const header = document.querySelector('.header-content');
            const hamburger = document.createElement('button');
            hamburger.innerHTML = '‚ò∞';
            hamburger.style.cssText = `
                background: none;
                border: none;
                color: #fff;
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
                margin-right: 15px;
            `;
            hamburger.onclick = toggleMobileSidebar;
            header.insertBefore(hamburger, header.firstChild);
        }

        // Valida√ß√£o de formul√°rios
        function validateForm(form) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc3545';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e8e8e8';
                }
            });

            return isValid;
        }

        // Adicionar valida√ß√£o a todos os formul√°rios
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function (e) {
                if (!validateForm(this)) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campos obrigat√≥rios',
                        text: 'Por favor, preencha todos os campos obrigat√≥rios.',
                        confirmButtonColor: '#370400'
                    });
                }
            });
        });
    </script>
    <script src="js/header-search.js"></script>
</body>

</html>